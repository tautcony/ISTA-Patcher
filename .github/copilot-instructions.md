# ISTA-Patcher Copilot Instructions

## Project Overview

IL-level patcher for BMW ISTA diagnostic software. Patches .NET assemblies using `dnlib`. License: GPL-3.0-or-later.

## Architecture

```
ISTA-Patcher (CLI)  ←─ DotMake.CommandLine, Serilog, Sentry, GenHTTP
ISTAvalon (GUI)     ←─ Avalonia 11, CommunityToolkit.Mvvm
  └─ both depend on ↓
ISTAlter (core lib) ←─ dnlib (IL r/w), Lib.Harmony, ImageSharp
  └─ uses ↓
ISTgenerAtor        ←─ Roslyn source generator (analyzer-only reference)
ISTestA             ←─ NUnit 4 tests for ISTAlter utilities
```

- **ISTAlter**: `Patch.PatchISTA()` orchestrates concurrent file patching via `ConcurrencyTaskScheduler`. `PatchUtils` is `static partial class` — partial body generated by `ISTgenerAtor`.
- **ISTAvalon**: `CommandDiscoveryService` reflects `ISTA-Patcher` CLI commands to build tabs dynamically. Log output forwarded via `DelegateLogSink` to the GUI log panel. ViewModels extend `ObservableObject`.
- **ISTA-Patcher**: `Global.Config` (static singleton) loads `appsettings.json` via `Microsoft.Extensions.Configuration`. `Global.LevelSwitch` is a Serilog `LoggingLevelSwitch` shared with GUI.
- CLI commands live in `src/ISTA-Patcher/Commands/`; each uses `[CliCommand]` from `DotMake.CommandLine` with `KebabCase` naming and `DoubleHyphen` prefix convention.

## Build & Test

```bash
dotnet restore          # restore locked packages (packages.lock.json committed per project)
dotnet build
dotnet build -c Release
dotnet test                                    # runs ISTestA (NUnit 4 + coverlet)
dotnet run --project src/ISTA-Patcher -- patch [options] "/PATH/TO/ISTA"
dotnet run --project src/ISTAvalon            # launch GUI

bash scripts/check_copyright_years.sh         # validate SPDX copyright year headers
```

SDK: .NET 10.0 (`global.json`, `rollForward: latestMajor`, `allowPrerelease: true`). Target framework: `net10.0`; `ISTgenerAtor` targets `netstandard2.0`.

## Code Style

Every `.cs` file **must** begin with SPDX headers (enforced by `check_copyright_years.sh`):

```csharp
// SPDX-License-Identifier: GPL-3.0-or-later
// SPDX-FileCopyrightText: Copyright YYYY[-YYYY] TautCony
```

- **Namespaces**: file-scoped (`namespace Foo.Bar;`, no braces)
- **Using directives**: placed after the file-scoped namespace declaration, grouped and sorted
- **Nullable**: `annotations` on library/app projects; `enable` on `ISTgenerAtor`
- **Implicit usings**: enabled — avoid explicit usings for common BCL types
- **Analyzers**: `StyleCop.Analyzers` + `Roslynator.Analyzers` on all projects (`PrivateAssets="all"`)
- **LINQ**: prefer `ZLinq` for zero-allocation LINQ in hot paths
- **Unsafe**: `AllowUnsafeBlocks` enabled in `ISTAlter`
- **Async**: CLI commands expose `RunAsync()` as the entry point
- See `src/ISTAlter/Core/PatchUtils.cs` and `src/ISTAvalon/ViewModels/` for representative patterns

## Project Conventions

- `packages.lock.json` is committed per project — run `dotnet restore` before building after any package changes
- `PatchUtils` is `static partial class`; source-generated members come from `ISTgenerAtor` — do not manually add generated members
- GUI command tabs are discovered reflectively — adding a new CLI command in `ISTA-Patcher/Commands/` automatically surfaces it in the GUI tab list
- Runtime identifiers in use: `win-x64`, `linux-x64`, `osx-x64`, `osx-arm64`

## OpenSpec Workflow

Structured change management under `openspec/`:

```
openspec/specs/          ← stable living specs (BDD format, ## ADDED/MODIFIED Requirements)
openspec/changes/        ← active changes: proposal.md → design.md → tasks.md [→ specs/]
openspec/changes/archive/ ← completed changes (moved here after verification)
```

Use the Copilot skills to manage this workflow:
- `@workspace /new-change` — start a new change
- `@workspace /apply-change` — implement tasks from an active change
- `@workspace /verify-change` — validate implementation before archiving
- `@workspace /archive-change` — finalize and archive

## Integration Points

- **Sentry**: crash/error reporting + profiling (`Sentry.Profiling`); configured in `appsettings.json`
- **GenHTTP**: embedded HTTP server for the `server` CLI command with OpenAPI/Swagger (`GenHTTP.Core/Modules`)
- **LibGit2Sharp**: Git operations within the patcher logic
- **BouncyCastle**: crypto operations in `CryptoCommand`/`CryptoController`
- **ImageSharp**: image manipulation in `ISTAlter` (branding/watermark patching)
