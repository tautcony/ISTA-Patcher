<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:ISTAvalon.ViewModels"
        xmlns:views="using:ISTAvalon.Views"
        xmlns:controls="using:ISTAvalon.Controls"
        xmlns:converters="using:ISTAvalon.Converters"
        xmlns:models="using:ISTAvalon.Models"
        xmlns:i="https://github.com/projektanker/icons.avalonia"
        x:Class="ISTAvalon.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="ISTA-Patcher"
        Width="1100" Height="700"
        MinWidth="700" MinHeight="400">

    <Window.Resources>
        <converters:LogLevelToBrushConverter x:Key="LogLevelToBrushConverter" />
        <converters:BoolToGridLengthConverter x:Key="BoolToGridLengthConverter" />
    </Window.Resources>

    <Window.DataTemplates>
        <!-- Bool parameter: checkbox -->
        <DataTemplate DataType="vm:BoolParameterViewModel">
            <StackPanel Margin="0,4">
                <CheckBox IsChecked="{Binding IsChecked}"
                          Content="{Binding Descriptor.DisplayName}"
                          ToolTip.Tip="{Binding Descriptor.Description}" />
            </StackPanel>
        </DataTemplate>

        <!-- Enum parameter: dropdown -->
        <DataTemplate DataType="vm:EnumParameterViewModel">
            <StackPanel Margin="0,4" Spacing="2">
                <TextBlock Text="{Binding Descriptor.DisplayName}"
                           ToolTip.Tip="{Binding Descriptor.Description}" />
                <ComboBox ItemsSource="{Binding EnumValues}"
                          SelectedItem="{Binding SelectedValue}"
                          HorizontalAlignment="Stretch" />
            </StackPanel>
        </DataTemplate>

        <!-- Numeric parameter: numeric up-down -->
        <DataTemplate DataType="vm:NumericParameterViewModel">
            <StackPanel Margin="0,4" Spacing="2">
                <TextBlock Text="{Binding Descriptor.DisplayName}"
                           ToolTip.Tip="{Binding Descriptor.Description}" />
                <NumericUpDown Value="{Binding NumericValue}"
                               HorizontalAlignment="Stretch" />
            </StackPanel>
        </DataTemplate>

        <!-- Path parameter: textbox + browse button + drag-drop -->
        <DataTemplate DataType="vm:PathParameterViewModel">
            <StackPanel Margin="0,4" Spacing="2">
                <TextBlock Text="{Binding Descriptor.DisplayName}"
                           ToolTip.Tip="{Binding Descriptor.Description}" />
                <views:PathEditor />
            </StackPanel>
        </DataTemplate>

        <!-- String parameter: textbox -->
        <DataTemplate DataType="vm:StringParameterViewModel">
            <StackPanel Margin="0,4" Spacing="2">
                <TextBlock Text="{Binding Descriptor.DisplayName}"
                           ToolTip.Tip="{Binding Descriptor.Description}" />
                <TextBox Text="{Binding TextValue}"
                         Watermark="{Binding Descriptor.Description}"
                         HorizontalAlignment="Stretch" />
            </StackPanel>
        </DataTemplate>

        <!-- String array parameter: multiline textbox -->
        <DataTemplate DataType="vm:StringArrayParameterViewModel">
            <StackPanel Margin="0,4" Spacing="2">
                <TextBlock Text="{Binding Descriptor.DisplayName}"
                           ToolTip.Tip="{Binding Descriptor.Description}" />
                <TextBox Text="{Binding TextValue}"
                         Watermark="Comma-separated values"
                         AcceptsReturn="True"
                         MinHeight="60"
                         HorizontalAlignment="Stretch" />
            </StackPanel>
        </DataTemplate>
    </Window.DataTemplates>

    <DockPanel Margin="8">
        <TabControl ItemsSource="{Binding CommandTabs}"
                    SelectedItem="{Binding SelectedTab}">
            <TabControl.ItemTemplate>
                <DataTemplate x:DataType="vm:CommandTabViewModel">
                    <TextBlock Text="{Binding Name}" />
                </DataTemplate>
            </TabControl.ItemTemplate>

            <TabControl.ContentTemplate>
                <DataTemplate x:DataType="vm:CommandTabViewModel">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" MinWidth="250" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="{Binding IsLogPanelExpanded, Converter={StaticResource BoolToGridLengthConverter}}"
                                              MinWidth="0" />
                        </Grid.ColumnDefinitions>

                        <!-- Left column: Parameters + Execute bar -->
                        <DockPanel Grid.Column="0">
                            <!-- Execute bar -->
                            <DockPanel DockPanel.Dock="Bottom" Margin="0,8,0,0">
                                <Button DockPanel.Dock="Right"
                                        Content="Execute"
                                        Command="{Binding ExecuteCommandCommand}"
                                        Padding="16,8"
                                        HorizontalContentAlignment="Center" />
                                <TextBlock Text="{Binding StatusText}"
                                           VerticalAlignment="Center"
                                           Margin="0,0,12,0" />
                            </DockPanel>

                            <!-- Parameters scroll area -->
                            <ScrollViewer Padding="0,0,8,0">
                                <StackPanel>
                                    <TextBlock Text="{Binding Description}"
                                               FontStyle="Italic"
                                               Margin="0,0,0,8"
                                               IsVisible="{Binding Description, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                                    <ItemsControl ItemsSource="{Binding Parameters}" />
                                </StackPanel>
                            </ScrollViewer>
                        </DockPanel>

                        <!-- GridSplitter -->
                        <GridSplitter Grid.Column="1"
                                      Width="4"
                                      ResizeDirection="Columns"
                                      IsVisible="{Binding IsLogPanelExpanded}" />

                        <!-- Right column: Log panel -->
                        <Border Grid.Column="2"
                                BorderBrush="Gray" BorderThickness="1"
                                CornerRadius="4"
                                IsVisible="{Binding IsLogPanelExpanded}">
                            <DockPanel>
                                <!-- Log panel header -->
                                <Border DockPanel.Dock="Top"
                                        Background="Transparent"
                                        CornerRadius="4,4,0,0"
                                        Padding="8,4">
                                    <DockPanel>
                                        <TextBlock Text="Log"
                                                   FontWeight="SemiBold"
                                                   VerticalAlignment="Center" />
                                        <StackPanel DockPanel.Dock="Right"
                                                    Orientation="Horizontal"
                                                    Spacing="4"
                                                    HorizontalAlignment="Right">
                                            <Button Command="{Binding CopyAllCommand}"
                                                    ToolTip.Tip="Copy All"
                                                    Padding="4,2">
                                                <i:Icon Value="fa-regular fa-copy" FontSize="14" />
                                            </Button>
                                            <Button Command="{Binding ClearOutputCommand}"
                                                    ToolTip.Tip="Clear"
                                                    Padding="4,2">
                                                <i:Icon Value="fa-solid fa-trash-can" FontSize="14" />
                                            </Button>
                                            <Button Command="{Binding ToggleLogPanelCommand}"
                                                    ToolTip.Tip="Collapse"
                                                    Padding="4,2">
                                                <i:Icon Value="fa-solid fa-angles-right" FontSize="14" />
                                            </Button>
                                        </StackPanel>
                                    </DockPanel>
                                </Border>

                                <!-- Log entries list -->
                                <ListBox ItemsSource="{Binding OutputLines}"
                                         Background="Transparent"
                                         ScrollViewer.HorizontalScrollBarVisibility="Auto">
                                    <ListBox.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Copy All"
                                                      Command="{Binding CopyAllCommand}" />
                                            <MenuItem Header="Clear"
                                                      Command="{Binding ClearOutputCommand}" />
                                        </ContextMenu>
                                    </ListBox.ContextMenu>
                                    <ListBox.Styles>
                                        <Style Selector="ListBoxItem">
                                            <Setter Property="Padding" Value="4,1" />
                                            <Setter Property="MinHeight" Value="0" />
                                        </Style>
                                    </ListBox.Styles>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate x:DataType="models:LogEntry">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <StackPanel.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy Line"
                                                                  Tag="{Binding}"
                                                                  Click="OnCopyLineClick" />
                                                    </ContextMenu>
                                                </StackPanel.ContextMenu>
                                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss.fff}'}"
                                                           Foreground="{x:Static models:LogPanelPalette.TimestampBrush}"
                                                           FontFamily="Cascadia Code,Consolas,Menlo,monospace"
                                                           FontSize="12"
                                                           VerticalAlignment="Center" />
                                                <controls:HighlightedLogTextBlock
                                                    LogEntry="{Binding}"
                                                    FontFamily="Cascadia Code,Consolas,Menlo,monospace"
                                                    FontSize="12"
                                                    VerticalAlignment="Center" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </DockPanel>
                        </Border>

                        <!-- Expand toggle (visible when panel is collapsed, placed in auto-width splitter column) -->
                        <Button Grid.Column="1"
                                IsVisible="{Binding !IsLogPanelExpanded}"
                                VerticalAlignment="Top"
                                HorizontalAlignment="Center"
                                Margin="2,4"
                                Padding="4"
                                ToolTip.Tip="Expand Log"
                                Command="{Binding ToggleLogPanelCommand}">
                            <i:Icon Value="fa-solid fa-angles-left" FontSize="14" />
                        </Button>
                    </Grid>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </DockPanel>
</Window>
